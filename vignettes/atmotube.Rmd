---
title: "tidypollute: Getting Started with the Atmotube Cloud API"
author: "Dr. Nelson Roque"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{tidypollute: Getting Started with the Atmotube Cloud API}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Getting Started with `tidypollute`

## Goals of this Notebook

This vignette demonstrates how to use the `get_atmotube_data()` to **download Atmotube data** [via the Atmotube Cloud API](https://app.swaggerhub.com/apis-docs/Atmotube/cloud_api/1.4) using the `tidypollute` package.

## API Authentication

To access the Atmotube API, you need:
- An **API key** (provided by Atmotube)
- The **MAC address** of your Atmotube device

Make sure you store your API key securely.

------------------------------------------------------------------------

## Retrieving Data

### Fetching Data in JSON Format

Use `get_atmotube_data()` to retrieve air quality data:

```r
api_key <- "your_api_key_here"
mac <- "d3:8e:70:ac:49:68"
start_date <- "2024-10-20"
end_date <- "2024-10-27"

data <- get_atmotube_data(api_key, mac, start_date, end_date, format = "json")

# View the structure of the response
str(data)
```

### Fetching Data in CSV Format

If you prefer a **CSV** response:

```r
csv_data <- get_atmotube_data(api_key, mac, start_date, end_date, format = "csv")

# Print first few rows (if using read.csv)
read.csv(text = csv_data, sep = ";") |> head()
```

## Parameter Options

The function supports several parameters:

| Parameter   | Description | Default | Valid Values |
|-------------|------------|---------|-------------|
| `order`     | Sorting order | `"asc"` | `"asc"`, `"desc"` |
| `format`    | Response format | `"json"` | `"json"`, `"csv"` |
| `offset`    | Pagination offset | `0` | `â‰¥0` |
| `limit`     | Number of records | `1440` | `1-1440` |
| `separator` | CSV separator | `"semicolon"` | Any delimiter |

### Example: Fetching a Limited Dataset for a Single Device

```r
small_data <- get_atmotube_data(api_key, mac, start_date, end_date, limit = 10)
print(small_data)
```

### Example: Fetching Large Intervals of Data (more than 7 days) for a Single Device

```r
api_key <- "your_api_key_here"
mac <- "aa:bb:cc:dd:ee:ff"
start_date <- "2024-06-01"
end_date <- "2024-07-01"
data <- get_atmotube_data_bulk(api_key, mac, start_date, end_date)
print(data)
```

### Example: Fetching Data for Multiple Devices, Across Large Intervals

```r
library(dplyr)
library(tidyr)
library(purrr)

# Example table with multiple Atmotube devices & date ranges
mac_table <- tibble::tibble(
  mac = c("aa:bb:cc:dd:ee:ff", "11:22:33:44:55:66"),
  start_date = c("2024-06-01", "2024-06-10"),
  end_date = c("2024-07-01", "2024-07-05")
)

# Your Atmotube API Key
api_key <- "your_api_key_here"

# Fetch data and unnest results into a long format
results_df <- mac_table %>%
  rowwise() %>%
  mutate(data = list(get_atmotube_data_bulk(api_key, mac, start_date, end_date))) %>%
  ungroup() %>%
  unnest(data)  # Expands lists into rows

# View tidy output
print(results_df)
```

## Error Handling

The function automatically checks for:
- Invalid API parameters

- Improper MAC address formatting

- Out-of-range values for `limit`, `offset`, etc.

Example of an invalid request:

```r
get_atmotube_data(api_key, "invalid_mac", start_date, end_date)
# Error: Invalid 'mac' parameter. Must be in format 'aa:bb:cc:dd:ee:ff'.
```

---

## Summary

This notebook provides a **simple workflow** for retrieving EPA AirData using `tidypollute`.

You can:

âœ… Introduces `get_atmotube_data()`  and `get_atmotube_data_bulk()`

âœ… Explains how to install & authenticate  

âœ… Provides examples for JSON & CSV  

âœ… Shows parameter options with a table

âœ… Includes error handling examples  

## Conclusion

This vignette provides a quick guide to fetching air quality data using the Atmotube API in R. For further details, refer to the API documentation. Happy coding! ðŸš€

For more details, check out [`tidypollute` documentation](https://nelsonroque.github.io/tidypollute/index.html).
